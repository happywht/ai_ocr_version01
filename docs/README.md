# 专用发票OCR识别工具

使用umi-OCR服务识别专用发票并自动提取关键信息的Python工具。

## 功能特性

- ✅ 通过HTTP接口调用umi-OCR服务
- ✅ 专用发票格式字段识别
- ✅ 自动提取发票号码、开票日期、双方名称、金额和税额
- ✅ 支持JSON和TXT格式输出
- ✅ 完整的错误处理和日志记录
- ✅ 命令行界面，易于使用

## 提取字段

1. **发票号码** - 发票的唯一标识号码
2. **开票日期** - 发票开具日期
3. **销售方名称** - 开票方的名称
4. **购买方名称** - 接收发票方的名称
5. **合计金额** - 价税合计金额
6. **税额** - 增值税金额

## 环境要求

- Python 3.7+
- 已安装并运行的umi-OCR服务 (HTTP端口: 127.0.0.1:1224)
- requests库
- Pillow库 (GUI版本需要)

## 安装依赖

```bash
pip install requests Pillow

# 或使用requirements.txt
pip install -r requirements.txt
```

## 使用方法

### 🖥️ GUI版本 (推荐)

#### 快速启动
```bash
# 方法1: 使用启动脚本 (推荐)
python start_gui.py

# 方法2: 直接运行GUI
python invoice_gui.py

# 方法3: Windows用户双击 run.bat
```

#### GUI功能特性
- ✅ **图片选择和预览** - 可视化选择发票图片，实时预览
- ✅ **一键识别** - 点击按钮即可开始OCR识别
- ✅ **结构化结果显示** - 清晰的表格展示提取字段
- ✅ **原始OCR结果查看** - 可查看完整的OCR识别结果
- ✅ **多格式导出** - 支持JSON、TXT、CSV格式导出
- ✅ **批量处理** - 支持目录批量处理，进度显示
- ✅ **实时状态监控** - 显示OCR服务连接状态和处理进度
- ✅ **错误处理** - 友好的错误提示和处理

#### GUI界面布局
```
┌─────────────────────────────────────────────────────────────┐
│                    专用发票OCR识别工具                         │
├─────────────────────┬───────────────────────────────────────┤
│    图片选择区域      │           识别结果区域                 │
│  ┌───────────────┐  │  ┌───────────────────────────────────┐ │
│  │ 选择发票图片    │  │  │ 提取字段 │ 原始OCR结果 │          │ │
│  │ ────────────   │  │  └───────────────────────────────────┘ │
│  │ 图片预览区域    │  │                                       │
│  └───────────────┘  │                                       │
│                     │                                       │
├─────────────────────┴───────────────────────────────────────┤
│ [开始识别] [导出结果] [批量处理] [清除结果]                   │
└─────────────────────────────────────────────────────────────┘
```

### ⌨️ 命令行版本

#### 基本用法

```bash
python invoice_ocr_tool.py 发票图片.jpg
```

#### 指定输出文件和格式

```bash
python invoice_ocr_tool.py 发票图片.jpg -o 结果.json -f json
```

```bash
python invoice_ocr_tool.py 发票图片.jpg -o 结果.txt -f txt
```

#### 完整参数示例

```bash
python invoice_ocr_tool.py 发票图片.jpg \
  --output 结果.json \
  --format json \
  --host 127.0.0.1 \
  --port 1224 \
  --debug
```

### 命令行参数说明

- `image_path`: 发票图片文件路径 (必需)
- `-o, --output`: 输出文件路径 (可选，默认生成同目录_result文件)
- `-f, --format`: 输出格式，可选 `json` 或 `txt` (默认: json)
- `--host`: OCR服务主机地址 (默认: 127.0.0.1)
- `--port`: OCR服务端口 (默认: 1224)
- `--debug`: 开启调试模式，显示详细日志

## 输出格式

### JSON格式输出

```json
{
  "图片路径": "发票图片.jpg",
  "处理时间": "2024-01-01 12:00:00",
  "提取字段": {
    "发票号码": "12345678",
    "开票日期": "2024-01-01",
    "销售方名称": "某某科技有限公司",
    "购买方名称": "某某贸易有限公司",
    "合计金额": "11700.00",
    "税额": "1700.00"
  },
  "OCR原始结果": {...}
}
```

### TXT格式输出

```
发票识别结果
==================================================
图片路径: 发票图片.jpg
处理时间: 2024-01-01 12:00:00

提取字段:
------------------------------
发票号码: 12345678
开票日期: 2024-01-01
销售方名称: 某某科技有限公司
购买方名称: 某某贸易有限公司
合计金额: 11700.00
税额: 1700.00
```

## 错误处理

工具包含完整的错误处理机制：

1. **文件检查** - 验证输入图片文件是否存在
2. **服务连接** - 检查umi-OCR服务是否正常运行
3. **OCR识别** - 处理图片识别失败的情况
4. **字段提取** - 处理无法识别字段的情况
5. **文件保存** - 处理输出文件保存失败的情况

## 日志记录

- 普通模式：显示关键操作信息
- 调试模式 (`--debug`)：显示详细的OCR识别文本和处理过程

## 支持的图片格式

- JPG/JPEG
- PNG
- BMP
- TIFF
- GIF

## 性能说明

- 识别速度：取决于图片大小和OCR服务性能
- 准确性：依赖于图片质量和umi-OCR的识别能力
- 推荐图片分辨率：建议DPI不低于300

## 常见问题

### Q: 提示"无法连接到OCR服务"
A: 请确保umi-OCR服务已启动并运行在127.0.0.1:1224端口

### Q: 某些字段识别不准确
A: 请确保图片清晰、无倾斜、无遮挡，可尝试提高图片分辨率

### Q: 发票号码识别不到
A: 检查图片中发票号码是否清晰可见，可尝试裁剪图片只保留发票区域

## 技术架构

```
发票图片 → OCR识别 → 文本提取 → 正则匹配 → 字段提取 → 结果输出
```

## 许可证

本工具仅用于学习和合法的发票识别用途。